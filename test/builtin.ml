open Shared

let%expect_test "Int(bits) constructor" =
  let source =
    {|
      let i = Int(257).new(100);
      let overflow = Int(8).new(513);
    |}
  in
  pp source ;
  [%expect {|
    ◉
    ├─overflow│struct instance
    └─i│struct instance |}]

let%expect_test "Int(bits) serializer" =
  let source =
    {|
      fn test(b: Builder) {
        let i = Int(32).new(100);
        i.serialize(b);
      }
    |}
  in
  pp source ;
  [%expect
    {|
      ◉
      └─test│fn │b        │ ⟶ │_
            │   ├─────────┤   │
            │   │(Builder)│   │
            ├───┴─────────┴───┴───────────────────
            │┌─────────────────┐
            ││Let binding      │
            │├─┬───────────────┼─────────────────
            ││i│struct instance│
            │└─┴───────────────┘
            ├─────────────────────────────────────
            │┌─────────┬─┬─┬─┬─┬─┬───┬─────────┬─┐
            ││serialize│↗│(│i│↗│b│ : │(Builder)│)│
            │└─────────┴─┴─┴─┴─┴─┴───┴─────────┴─┘ |}]

let%expect_test "demo struct serializer" =
  let source =
    {|
      struct T {
        val a: Int(32)
        val b: Int(16)
      }
      let T_serializer = serializer(T);

      fn test() {
        let b = Builder.new();
        T_serializer(T{}, b);
      }
    |}
  in
  pp source ;
  [%expect
    {|
    ◉
    ├─test│fn ├┤ ⟶ │_
    │     ├───┴┴───┴───────────────────────────────────────────
    │     │┌───────────────────────┐
    │     ││Let binding            │
    │     │├─┬─────────────────────┼──────────────────────────
    │     ││b│┌───┬─┬─┬───────┬─┬─┐│
    │     ││ ││new│↗│(│Builder│↗│)││
    │     ││ │└───┴─┴─┴───────┴─┴─┘│
    │     │└─┴─────────────────────┘
    │     ├────────────────────────────────────────────────────
    │     │┌────────────┬─┬─┬───────────────┬─┬───┬─────────┬─┐
    │     ││T_serializer│↗│(│struct instance│b│ : │(Builder)│)│
    │     │└──────┬───┬─┴─┴┬┴────────┬───┬──┴─┴───┴─────────┴─┘
    ├─T_serializer│fn │self│builder  │ ⟶ │void
    │             │   ├────┼─────────┤   │
    │             │   │_   │(Builder)│   │
    │             ├───┴────┴─────────┴───┴─────────────────────────────────────────────────────────────────────────────────────────────────────────
    │             │┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │             ││Let binding                                                                                                                   │
    │             │├───────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │             ││builder│┌───┬────────────────────┬─────────┬───┬──────────────────────────────────────────────────┬─┬────┬───┬───┬─────────┬─┐│
    │             ││       ││fn │self                │builder  │ ⟶ │(Builder)                                         │(│self│ : │_•a│(Builder)│)││
    │             ││       ││   ├──────┬─────────────┼─────────┤   │                                                  │ │    │   │   │         │ ││
    │             ││       ││   │struct│┌───────┬───┐│(Builder)│   │                                                  │ │    │   │   │         │ ││
    │             ││       ││   │      ││integer│int││         │   │                                                  │ │    │   │   │         │ ││
    │             ││       ││   │      │└───────┴───┘│         │   │                                                  │ │    │   │   │         │ ││
    │             ││       │├───┴──┬──┬┴──────┬───┬──┴──────┬──┴───┼────┬───┬──────┬─────────────────────┬──────┬──┬──┤ │    │   │   │         │ ││
    │             ││       ││return│〈│builder│ : │(Builder)│signed│self│ : │struct│┌───────┬───┐•integer│bits: │32│〉│ │    │   │   │         │ ││
    │             ││       ││      │  │       │   │         │      │    │   │      ││integer│int│        │      │  │  │ │    │   │   │         │ ││
    │             ││       ││      │  │       │   │         │      │    │   │      │└───────┴───┘        │      │  │  │ │    │   │   │         │ ││
    │             ││       │└──────┴──┴───────┴───┴─────────┴──────┴────┴───┴──────┴─────────────────────┴──────┴──┴──┴─┴────┴───┴───┴─────────┴─┘│
    │             │└───────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    │             ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    │             │┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │             ││Let binding                                                                                                                   │
    │             │├───────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
    │             ││builder│┌───┬────────────────────┬─────────┬───┬──────────────────────────────────────────────────┬─┬────┬───┬───┬─────────┬─┐│
    │             ││       ││fn │self                │builder  │ ⟶ │(Builder)                                         │(│self│ : │_•b│(Builder)│)││
    │             ││       ││   ├──────┬─────────────┼─────────┤   │                                                  │ │    │   │   │         │ ││
    │             ││       ││   │struct│┌───────┬───┐│(Builder)│   │                                                  │ │    │   │   │         │ ││
    │             ││       ││   │      ││integer│int││         │   │                                                  │ │    │   │   │         │ ││
    │             ││       ││   │      │└───────┴───┘│         │   │                                                  │ │    │   │   │         │ ││
    │             ││       │├───┴──┬──┬┴──────┬───┬──┴──────┬──┴───┼────┬───┬──────┬─────────────────────┬──────┬──┬──┤ │    │   │   │         │ ││
    │             ││       ││return│〈│builder│ : │(Builder)│signed│self│ : │struct│┌───────┬───┐•integer│bits: │16│〉│ │    │   │   │         │ ││
    │             ││       ││      │  │       │   │         │      │    │   │      ││integer│int│        │      │  │  │ │    │   │   │         │ ││
    │             ││       ││      │  │       │   │         │      │    │   │      │└───────┴───┘        │      │  │  │ │    │   │   │         │ ││
    │             ││       │└──────┴──┴───────┴───┴─────────┴──────┴────┴───┴──────┴─────────────────────┴──────┴──┴──┴─┴────┴───┴───┴─────────┴─┘│
    │             │└───────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    │             ├──────┬───────┬───┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────
    │             │return│builder│ : │(Builder)
    └─T│struct│┌─┬┴─────┬┴───────┴───┴┐
       │      ││a│struct│┌───────┬───┐│
       │      ││ │      ││integer│int││
       │      ││ │      │└───────┴───┘│
       │      │├─┼──────┼─────────────┤
       │      ││b│struct│┌───────┬───┐│
       │      ││ │      ││integer│int││
       │      ││ │      │└───────┴───┘│
       │      │└─┴──────┴─────────────┘ |}]
